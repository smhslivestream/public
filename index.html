<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>SMHS Livestream Events</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f8f9fa;
      margin: 0;
      padding: 2rem;
      color: #333;
    }
    h1 { text-align: center; margin-bottom: 0.5rem; }
    h2 { text-align: center; margin: 0.75rem 0 0.25rem; }
    h3 { margin: 0.5rem 0 0.25rem; }
    .sub { text-align: center; color: #666; margin-bottom: 1.25rem; }

    .section { margin-top: 1.25rem; }

    .card {
      background: white;
      box-shadow: 0 0 10px rgba(0,0,0,0.08);
      border-radius: 12px;
      padding: 14px 16px;
      margin: 14px 0;
      overflow: hidden;
    }

    .eventHeader {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
    }

    .eventTitle {
      font-size: 1.05rem;
      font-weight: bold;
      margin-bottom: 2px;
    }

    .muted { color: #777; }
    .center { text-align: center; }

    .badge {
      display: inline-block;
      padding: 5px 10px;
      border-radius: 999px;
      font-size: 12px;
      color: #fff;
      background: #0077cc;
      white-space: nowrap;
    }
    .badge.current { background: #0aa06e; }
    .badge.upcoming { background: #0077cc; }
    .badge.latest { background: #7b5cff; } /* just a different tone */

    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      margin-top: 10px;
      overflow: hidden;
      border-radius: 8px;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 10px 12px;
      text-align: left;
      vertical-align: top;
      word-break: break-word;
    }
    th { background: #0077cc; color: white; }
    tr:nth-child(even) { background: #f2f2f2; }

    a { color: #0077cc; text-decoration: none; }
    a:hover { text-decoration: underline; }

    button {
      padding: 10px 15px;
      margin: 5px;
      border: none;
      border-radius: 6px;
      background: #0077cc;
      color: white;
      cursor: pointer;
      font-size: 14px;
    }
    button:hover { background: #005fa3; }

    details summary {
      cursor: pointer;
      font-weight: bold;
      margin-top: 8px;
    }
    details summary:hover { text-decoration: underline; }

    .divider {
      height: 1px;
      background: #ddd;
      margin: 18px 0;
    }

    .miniCopyRow { margin-top: 6px; }
  </style>
</head>
<body>
  <h1>√âcole St. Mary High School Livestreaming Page</h1>
  <div class="sub" id="statusLine">Loading events...</div>

  <!-- CLOSEST EVENT TO TODAY (from current-flagged) -->
  <div class="section">
    <h2>Closest Event</h2>
    <div id="closestContainer"></div>
  </div>

  <div class="divider"></div>

  <!-- UPCOMING (current-flagged, but later than closest) -->
  <div class="section">
    <h2>Upcoming Events</h2>
    <div class="sub">Current-flagged events with dates after the closest event.</div>
    <div id="upcomingContainer"></div>
  </div>

  <div class="divider"></div>

  <!-- LATEST (still current-flagged) -->
  <div class="section">
    <h2>Latest Events</h2>
    <div class="sub">Current-flagged events that already happened (most recent first).</div>
    <div id="latestContainer"></div>
  </div>

  <div class="divider"></div>

  <h4 class="center"><a href="past.html">üóÑÔ∏è View past events</a></h4>
  <h5 class="center"><b>Livestream links provided by <i>√âcole St. Mary High School A/V & Livestreaming Crew.</i></b></h5>
  <h6 class="center muted">Version 2.1.0</h6>

  <!-- FOLLOW US ON INSTAGRAM -->
  <div style="text-align:center; margin-top:2rem; padding-top:1.5rem; border-top:1px solid #ddd;">
    <a href="https://www.instagram.com/smhs_livestream/" target="_blank"
       style="display:inline-flex; align-items:center; gap:10px; text-decoration:none; color:#333; font-family:Arial, sans-serif;">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" width="28" height="28" fill="#E1306C">
        <path d="M349.33 69.33h-186.7A93.67 93.67 0 0 0 69 163v186a93.67 93.67 0 0 0 93.67 93.67h186.66A93.67 93.67 0 0 0 443 349.33V163A93.67 93.67 0 0 0 349.33 69.33Zm61.34 280a61.35 61.35 0 0 1-61.34 61.34h-186.7a61.35 61.35 0 0 1-61.34-61.34v-186.7a61.35 61.35 0 0 1 61.34-61.34h186.66a61.35 61.35 0 0 1 61.34 61.34Z"/>
        <path d="M256 164.1A91.9 91.9 0 1 0 347.9 256 91.91 91.91 0 0 0 256 164.1Zm0 151.42A59.52 59.52 0 1 1 315.52 256 59.52 59.52 0 0 1 256 315.52Z"/>
        <circle cx="365.44" cy="146.56" r="20.44"/>
      </svg>
      <span style="font-size:1.1rem;"><b>Follow us on Instagram</b><br>@smhs_livestream</span>
    </a>
  </div>

  <script>
    const jsonUrl =
      "https://raw.githubusercontent.com/smhslivestream/event-links/main/liens.json?nocache=" +
      Date.now();

    function toLocalMidnight(dateObj) {
      const d = new Date(dateObj);
      d.setHours(0,0,0,0);
      return d;
    }

    function parseISODate(iso) {
      if (!iso || !/^\d{4}-\d{2}-\d{2}$/.test(iso)) return null;
      const [y, m, d] = iso.split("-").map(n => parseInt(n, 10));
      return new Date(y, m - 1, d);
    }

    function formatISODateLabel(iso) {
      const d = parseISODate(iso);
      if (!d) return iso || "-";
      const weekday = d.toLocaleDateString("en-US", { weekday: "long" });
      const monthAbr = d.toLocaleDateString("en-US", { month: "short" });
      const dayNum = d.getDate();
      const year = d.getFullYear();
      return `${weekday}, ${monthAbr}. ${dayNum}, ${year}`;
    }

    function escapeHtml(str) {
      return String(str ?? "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function eventDateStats(evt) {
      const today = toLocalMidnight(new Date());
      const days = Array.isArray(evt.days) ? evt.days : [];
      const dates = days
        .map(d => parseISODate(d.date))
        .filter(Boolean)
        .map(d => toLocalMidnight(d))
        .sort((a,b) => a - b);

      const firstDateObj = dates.length ? dates[0] : null;
      const lastDateObj  = dates.length ? dates[dates.length - 1] : null;
      const nextDateObj  = dates.find(d => d >= today) || null;

      return { firstDateObj, lastDateObj, nextDateObj };
    }

    function daysUntil(dateObj) {
      const today = toLocalMidnight(new Date());
      const target = toLocalMidnight(dateObj);
      const ms = target - today;
      return Math.round(ms / (1000 * 60 * 60 * 24));
    }

    function buildDaysTable(days) {
      const courtNames = [...new Set((days || []).flatMap(day => Object.keys(day.links || {})))];

      let html = "<table><thead><tr><th>Date</th>";
      courtNames.forEach(court => (html += `<th>${escapeHtml(court)}</th>`));
      html += "</tr></thead><tbody>";

      (days || []).forEach(day => {
        const displayDate = (day.date && /^\d{4}-\d{2}-\d{2}$/.test(day.date))
          ? formatISODateLabel(day.date)
          : (day.label || "-");

        html += `<tr><td>${escapeHtml(displayDate)}</td>`;

        courtNames.forEach(court => {
          const link = day.links ? day.links[court] : null;
          if (link && typeof link === "string" && link.startsWith("http")) {
            html += `<td><a href="${escapeHtml(link)}" target="_blank">${escapeHtml(link)}</a></td>`;
          } else {
            html += `<td>${escapeHtml(link || "-")}</td>`;
          }
        });

        html += "</tr>";
      });

      html += "</tbody></table>";
      return html;
    }

    function renderMiniEventCard(evt, badgeKind) {
      // badgeKind: "closest" | "upcoming" | "latest"
      const title = evt.event_title || "Event";
      const { firstDateObj, lastDateObj, nextDateObj } = eventDateStats(evt);

      let badgeClass = "badge";
      let badgeText = "Event";

      if (badgeKind === "closest") {
        badgeClass += " current";
        if (nextDateObj) {
          const d = daysUntil(nextDateObj);
          badgeText = (d === 0) ? "Today" : `${d} day(s) away`;
        } else {
          badgeText = "Closest";
        }
      } else if (badgeKind === "upcoming") {
        badgeClass += " upcoming";
        if (nextDateObj) {
          const d = daysUntil(nextDateObj);
          badgeText = (d === 0) ? "Today" : `${d} day(s) away`;
        } else {
          badgeText = "Upcoming";
        }
      } else {
        badgeClass += " latest";
        badgeText = "Latest";
      }

      const whenLine = (() => {
        if (nextDateObj) return `Next: <b>${escapeHtml(nextDateObj.toLocaleDateString("en-CA"))}</b>`;
        if (lastDateObj) return `Last: <b>${escapeHtml(lastDateObj.toLocaleDateString("en-CA"))}</b>`;
        if (firstDateObj) return `Date: <b>${escapeHtml(firstDateObj.toLocaleDateString("en-CA"))}</b>`;
        return `<span class="muted">No dated days found</span>`;
      })();

      return `
        <div class="card miniEvent" data-event-title="${escapeHtml(title)}">
          <div class="eventHeader">
            <div>
              <div class="eventTitle">${escapeHtml(title)}</div>
              <div class="muted">${whenLine}</div>
            </div>
            <span class="${badgeClass}">${escapeHtml(badgeText)}</span>
          </div>

          <details>
            <summary>Show days & links</summary>
            ${buildDaysTable(Array.isArray(evt.days) ? evt.days : [])}

            <p class="center miniCopyRow">
              <button class="copyMiniFormatted">üìã Copy Event (Formatted)</button>
              <button class="copyMiniPlain">üìÑ Copy Event (Plain Text)</button>
            </p>
          </details>
        </div>
      `;
    }

    fetch(jsonUrl)
      .then(r => {
        if (!r.ok) throw new Error("Network response was not ok");
        return r.json();
      })
      .then(data => {
        const statusLine = document.getElementById("statusLine");
        const closestContainer = document.getElementById("closestContainer");
        const upcomingContainer = document.getElementById("upcomingContainer");
        const latestContainer = document.getElementById("latestContainer");

        if (!data || !Array.isArray(data.events)) {
          statusLine.textContent = "‚ö†Ô∏è Invalid JSON format.";
          closestContainer.innerHTML = `<div class="card"><div class="center muted">Invalid JSON format.</div></div>`;
          return;
        }

        const events = data.events.filter(e => e && typeof e === "object");
        const today = toLocalMidnight(new Date());

        // Only use events flagged current
        const currentFlagged = events.filter(e => e.current === true);

        // Compute stats once
        const flaggedWithStats = currentFlagged.map(e => ({ e, ...eventDateStats(e) }));

        // CLOSEST EVENT = the current-flagged event with the soonest nextDate (>= today).
        // If none have nextDate, fall back to the one with most recent lastDate.
        const withNext = flaggedWithStats.filter(x => x.nextDateObj).sort((a,b) => a.nextDateObj - b.nextDateObj);
        const withLast = flaggedWithStats.filter(x => x.lastDateObj).sort((a,b) => b.lastDateObj - a.lastDateObj);

        const closestEvent = withNext.length ? withNext[0].e : (withLast.length ? withLast[0].e : null);

        // UPCOMING = other current-flagged events that have nextDate AFTER the closestEvent's nextDate
        let upcoming = [];
        if (withNext.length) {
          const closestNext = withNext[0].nextDateObj;
          upcoming = withNext
            .slice(1) // everything after the closest in the already-sorted list
            .map(x => x.e);
        } else {
          // no future dates at all -> no upcoming
          upcoming = [];
        }

        // LATEST = current-flagged events that already happened (lastDate < today) sorted by lastDate desc
        const latest = flaggedWithStats
          .filter(x => x.lastDateObj && x.lastDateObj < today && !x.nextDateObj) // ended and no future days
          .sort((a,b) => b.lastDateObj - a.lastDateObj)
          .map(x => x.e);

        // Render
        closestContainer.innerHTML = closestEvent
          ? renderMiniEventCard(closestEvent, "closest")
          : `<div class="card"><div class="center muted">No current-flagged events found.</div></div>`;

        upcomingContainer.innerHTML = upcoming.length
          ? upcoming.map(e => renderMiniEventCard(e, "upcoming")).join("")
          : `<div class="card"><div class="center muted">No upcoming current-flagged events found.</div></div>`;

        latestContainer.innerHTML = latest.length
          ? latest.map(e => renderMiniEventCard(e, "latest")).join("")
          : `<div class="card"><div class="center muted">No latest current-flagged events found.</div></div>`;

        statusLine.textContent =
          `Current-flagged events: ${currentFlagged.length} ‚Ä¢ Upcoming shown: ${upcoming.length} ‚Ä¢ Latest shown: ${latest.length}`;
      })
      .catch(err => {
        console.error("Error loading JSON:", err);
        document.getElementById("statusLine").textContent = "‚ö†Ô∏è Failed to load event data.";
        document.getElementById("closestContainer").innerHTML =
          `<div class="card"><div class="center muted">‚ö†Ô∏è Failed to load event data.</div></div>`;
      });

    // --- Copy MINI cards (Closest / Upcoming / Latest) ---
    document.addEventListener("click", function (e) {
      const btnPlain = e.target.closest(".copyMiniPlain");
      const btnFmt = e.target.closest(".copyMiniFormatted");
      if (!btnPlain && !btnFmt) return;

      const card = e.target.closest(".miniEvent");
      if (!card) return;

      const title = card.querySelector(".eventTitle")?.innerText?.trim() || "Event";
      const table = card.querySelector("table");

      if (!table) {
        alert("No table found to copy!");
        return;
      }

      if (btnPlain) {
        let text = title + "\n\n";
        for (let row of table.rows) {
          const cells = Array.from(row.cells).map(cell => cell.innerText.trim());
          text += cells.join("\t") + "\n";
        }

        navigator.clipboard
          .writeText(text)
          .then(() => alert("‚úÖ Event copied as plain text!"))
          .catch(() => alert("‚ö†Ô∏è Failed to copy automatically."));
      }

      if (btnFmt) {
        const tempDiv = document.createElement("div");
        tempDiv.innerHTML = `<h2>${escapeHtml(title)}</h2>` + table.outerHTML;
        document.body.appendChild(tempDiv);

        const range = document.createRange();
        range.selectNode(tempDiv);
        const selection = window.getSelection();
        selection.removeAllRanges();
        selection.addRange(range);

        try {
          document.execCommand("copy");
          alert("‚úÖ Event copied with formatting!");
        } catch (err) {
          alert("‚ö†Ô∏è Unable to copy automatically. Please select and copy manually.");
        }

        selection.removeAllRanges();
        tempDiv.remove();
      }
    });
  </script>
</body>
</html>
